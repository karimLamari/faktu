# BLINK Invoice App - AI Development Guide

## üèóÔ∏è Architecture Overview

**Stack**: Next.js 15 (App Router) + React 19 + MongoDB + Stripe + NextAuth v5
**Invoice App** for freelancers with multi-tier subscriptions (Free/Pro/Business), PDF generation, OCR scanning, and legal compliance (French invoicing laws).

### Key Directories
- `src/app/` - Next.js App Router pages & API routes
- `src/components/` - Organized by feature: `invoices/`, `quotes/`, `expenses/`, `clients/`, `subscription/`, `common/`, `ui/`
- `src/lib/` - Business logic, services, templates
- `src/models/` - Mongoose schemas (User, Invoice, Quote, Client, Expense, etc.)
- `src/hooks/` - Custom React hooks (`useCRUD`, `useFormModal`, `useSubscription`, `useOCR`, etc.)
- `src/lib/validations/` - Zod schemas for form validation
- `scripts/` - Database migration & maintenance scripts

## üéØ Critical Patterns

### 1. CRUD Operations
Use the **`useCRUD` hook** for all data operations - eliminates boilerplate:
```typescript
const { data, loading, createItem, updateItem, deleteItem } = useCRUD<Invoice>({
  endpoint: '/api/invoices',
  onSuccess: (msg) => showNotification(msg),
});
```

### 2. Form Management
**Always use `useFormModal` + Zod validation**:
- Hook: `useFormModal<T>()` for modal state + form data
- Validation: Import schemas from `src/lib/validations/`
- Example: See `src/components/expenses/ExpenseFormModal.tsx`

**Never** create forms without Zod validation - all schemas exist in `src/lib/validations/`.

### 3. Authentication & Authorization
- **NextAuth v5** (beta) - config in `src/lib/auth/config.ts`
- Get session: `import { auth } from '@/lib/auth/auth'` then `const session = await auth()`
- Protect API routes: Check `session.user.id` exists
- Auth handlers: `src/app/api/auth/[...nextauth]/route.ts`

### 4. Database Patterns
- **Connection**: Always use `import dbConnect from '@/lib/db/mongodb'` before Mongoose operations
- **Soft deletes**: Models use `deletedAt` field (indexed) - filter with `{ deletedAt: null }`
- **User scoping**: Always filter by `userId` for data isolation
- **Transaction numbering**: Invoice/Quote numbers are auto-generated per user (see `User.invoiceNumbering` & `User.quoteNumbering`)

### 5. PDF Generation System
**Two separate systems** (do NOT mix):

**Invoices**: `src/lib/invoice-templates/`
- 4 templates: Modern, Classic, Minimal, Creative
- Components: `src/lib/invoice-templates/templates/` (React-PDF)
- Generator: `src/lib/services/pdf-generator.tsx` ‚Üí `generateInvoicePdf()`
- Storage: `invoices/{userId}/{year}/{invoiceNumber}.pdf`

**Quotes**: `src/lib/quote-templates/`
- Mirror structure of invoice templates
- Generator: `generateQuotePdf()`
- Storage: `contracts/{userId}/{contractId}/{quoteNumber}.pdf`

**Legal Finalization** (invoices only):
- Once sent, invoices become **immutable** (French law Article L123-22)
- Fields: `isFinalized`, `finalizedAt`, `pdfPath`, `pdfHash` (SHA-256)
- Audit trail: `InvoiceAudit` model logs all actions
- Service: `src/lib/invoices/storage.ts`

### 6. Subscription System
- Plans defined in `src/lib/subscription/plans.ts` (Free/Pro/Business)
- Usage tracking: `User.usage` (invoices, quotes, expenses counts)
- Check limits: `useSubscription` hook
- Stripe integration: `src/app/api/stripe/` & webhooks at `/api/webhooks/stripe/`
- Components: `UsageBar`, `LimitReachedModal`, `UpgradeModal`, `PlanBadge`

### 7. OCR (Expense Scanning)
**Hybrid system** based on plan:
- **Free**: Tesseract.js (client-side, 70-75% accuracy)
- **Pro/Business**: Google Cloud Vision API (90-95% accuracy)
- Hook: `useOCR()` auto-selects provider
- Config: `OCR_PROVIDER=hybrid` in `.env.local`
- Service: `src/lib/services/ocr-provider.ts`

## üõ†Ô∏è Development Workflows

### Running the App
```powershell
npm run dev          # Dev server on :3000
npm run build        # Production build
npm start            # Production server
```

### Docker Deployment
```powershell
docker-compose up -d   # Requires .env file
# Volumes: ./contracts & ./invoices for persistent PDFs
# Health check: /api/health endpoint
```

### Database Scripts (Run from `scripts/`)
```powershell
# Check/fix invoice numbering
node --loader ts-node/esm check-invoice-numbers.ts

# Migrate schema changes
node migrate-add-finalization-fields.js

# Stripe operations
node create-stripe-products.js
node get-stripe-products.js
```

**Important**: Scripts connect directly to MongoDB - ensure `MONGODB_URI` in `.env.local`

### PWA Support
- Service worker: `public/sw.js` (auto-generated by `scripts/generate-sw.js`)
- Manifest: `public/manifest.json`
- Icons: `public/icons/` (generate with `npm run generate-icons`)
- Install prompt: `src/components/providers/PWAInstaller.tsx`

## üìù Code Conventions

### File Organization
- **Features first**: Group by domain (`invoices/`, `quotes/`, `clients/`), not tech layer
- **Colocation**: Keep related components together
- **Index exports**: Use `src/hooks/index.ts` for clean imports

### TypeScript
- **Path alias**: `@/*` maps to `src/*`
- **Model types**: Import from `@/models/` (Mongoose documents have TypeScript interfaces)
- **Validation types**: Infer from Zod schemas: `type InvoiceFormData = z.infer<typeof invoiceSchema>`

### API Routes (App Router)
- Location: `src/app/api/{resource}/route.ts` or `[id]/route.ts`
- Exports: `export async function GET/POST/PATCH/DELETE(request: NextRequest)`
- Auth: Always verify `session.user.id`
- Response: `NextResponse.json({ data, error }, { status })`

### Environment Variables
**Required** (add to `.env.local`):
```env
MONGODB_URI=
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=
RESEND_API_KEY=              # Email service
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
GOOGLE_CLOUD_VISION_API_KEY= # For Pro OCR
```

### Styling
- **Tailwind CSS** + `tailwind-merge` utility
- Components: shadcn/ui based (Radix UI primitives)
- Icons: `lucide-react` (prefer) or `react-icons`
- Responsive: Mobile-first design

## üîç Known Issues & Cleanup Needed

### Template Organization
- `src/lib/templates/` is **legacy** - contains old HTML-based PDF generators (unused)
- **Active systems**: `src/lib/invoice-templates/` and `src/lib/quote-templates/`
- Email templates: `src/lib/email-templates/` (Resend service)

### Form Validation Migration (In Progress)
Some forms lack client-side validation. Reference `FORMS_VALIDATION_SUMMARY.md` for status.
**Template**: See `EXAMPLE_ExpenseFormModal_Refactored.tsx` for best practices.

### Naming Consistency
- `InvoiceTemplate` vs `QuoteTemplate` models refer to **user-saved template configs**, not PDF layouts
- PDF layouts called "templates" too - distinguish by context

## üöÄ Quick Start for Common Tasks

### Add a New Feature
1. Create component in `src/components/{feature}/`
2. Add API route in `src/app/api/{feature}/route.ts`
3. Create Zod schema in `src/lib/validations/{feature}.ts`
4. Use `useCRUD` hook for data operations
5. Update model in `src/models/` if needed

### Add Form Validation
1. Create/update Zod schema in `src/lib/validations/`
2. Use `useZodForm` hook (if available) or `useFormModal` + manual validation
3. Display errors with field-level feedback

### Add Subscription Check
```typescript
const { hasFeature } = useSubscription();
if (!hasFeature('advancedStats')) {
  // Show UpgradeModal
}
```

### Generate PDFs
**Invoices**: Call `/api/invoices/[id]/pdf` (POST)
**Quotes**: Call `/api/quotes/[id]/pdf` (POST)
Both store files permanently and return download URLs.

## üìö Key Documentation
- `docs/FINALIZATION_SYSTEM_COMPLETE.md` - Invoice legal compliance
- `docs/OCR-HYBRID-SYSTEM.md` - OCR architecture
- `docs/STRIPE_WEBHOOK_SETUP.md` - Payment setup
- `docs/LAYOUTS-GUIDE.md` - PDF template system
- `FORMS_VALIDATION_SUMMARY.md` - Form audit status
- `ARCHITECTURE_CLEANUP_CHECKLIST.md` - Technical debt tracking
